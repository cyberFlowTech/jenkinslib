pipeline {
    
    agent {
      label 'macos4'
    }


    parameters {
        
        // 基本参数/传参

        string(
            name: "Package",
            defaultValue: 'Debug',
            description: '包类型'
        )

        string(
            name: 'Branch', 
            defaultValue: 'main', 
            description: '默认分支或者Tag'
        )

        string(
            name: "RepoUrl",
            defaultValue: '$GITLAB/mimo-app-ios.git',
            description: '代码仓库地址'
        )

        string(
            name: "Version",
            defaultValue: '2.0.0',
            description: 'app版本号'
        )
    }

    environment {


        // 传参转为环境变量
        branch = "$params.Branch"
        url = "$params.RepoUrl"


    }
    
    stages {
        stage('command') {
            steps{
                sh '''
                rm -rf /Users/apple/Documents/git/jenkins/workspace/MIMO_iOS_Debug/ios_pack/*
                cd ~/ios_test/mimo-app-ios/
                ./CI.sh $Version $BUILD_NUMBER
                '''
            }
        }
        
    }
    post{
        always {
            wrap([$class: 'BuildUser']) {
sh """
pack_name=\$(ls /Users/apple/Documents/git/jenkins/workspace/MIMO_iOS_Debug/ios_pack/)
echo "
#!/bin/bash
MESSAGE='{\\"api\\":\\"m_1691395722\\",\\"time\\":1691397277,\\"data\\":[\\"
### 原生 IOS ${env.Package}包 ###\\\\\\n
- 执行人: ${env.BUILD_USER}\\\\\\n
- 执行结果: "${currentBuild.currentResult}"\\\\\\n
- 分支: ${env.branch}\\\\\\n
- 版本号: ${env.Version}\\\\\\n
- 包类型：${env.Package}包\\\\\\n
- 差异: ${env.BUILD_URL}last-changes/\\\\\\n
- 日志: ${env.BUILD_URL}console\\\\\\n
- ipa地址：http://192.168.0.240:7050/Share/IOS_PACK/Debug/\${pack_name}
\\"],\\"sign\\":\\"b68f5dcd4d2a3d778d282567208e8690\\"}'
echo -n \\\$MESSAGE | nc -u -w1 13.212.162.101 31164
" > ./send.sh && /usr/local/bin/gsed -E -i "s/http:\\/\\/jenkins:8080/https:\\/\\/jenkins.mimo.immo/g" ./send.sh && /bin/bash ./send.sh
    """
            }
            
        }
        success {
            archiveArtifacts artifacts: '**/*.ipa'
        
        }
    }
}